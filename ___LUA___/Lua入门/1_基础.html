<!DOCTYPE html><html><head>
      <title>1_基础</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="file:///c:\Users\wb.yangyuxing01\.vscode\extensions\shd101wyy.markdown-preview-enhanced-0.8.18\crossnote\dependencies\katex\katex.min.css">
      
      
      
      
      
      <style>
      code[class*=language-],pre[class*=language-]{color:#333;background:0 0;font-family:Consolas,"Liberation Mono",Menlo,Courier,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.4;-moz-tab-size:8;-o-tab-size:8;tab-size:8;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:.8em;overflow:auto;border-radius:3px;background:#f5f5f5}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal;background:#f5f5f5}.token.blockquote,.token.comment{color:#969896}.token.cdata{color:#183691}.token.doctype,.token.macro.property,.token.punctuation,.token.variable{color:#333}.token.builtin,.token.important,.token.keyword,.token.operator,.token.rule{color:#a71d5d}.token.attr-value,.token.regex,.token.string,.token.url{color:#183691}.token.atrule,.token.boolean,.token.code,.token.command,.token.constant,.token.entity,.token.number,.token.property,.token.symbol{color:#0086b3}.token.prolog,.token.selector,.token.tag{color:#63a35c}.token.attr-name,.token.class,.token.class-name,.token.function,.token.id,.token.namespace,.token.pseudo-class,.token.pseudo-element,.token.url-reference .token.variable{color:#795da3}.token.entity{cursor:help}.token.title,.token.title .token.punctuation{font-weight:700;color:#1d3e81}.token.list{color:#ed6a43}.token.inserted{background-color:#eaffea;color:#55a532}.token.deleted{background-color:#ffecec;color:#bd2c00}.token.bold{font-weight:700}.token.italic{font-style:italic}.language-json .token.property{color:#183691}.language-markup .token.tag .token.punctuation{color:#333}.language-css .token.function,code.language-css{color:#0086b3}.language-yaml .token.atrule{color:#63a35c}code.language-yaml{color:#183691}.language-ruby .token.function{color:#333}.language-markdown .token.url{color:#795da3}.language-makefile .token.symbol{color:#795da3}.language-makefile .token.variable{color:#183691}.language-makefile .token.builtin{color:#0086b3}.language-bash .token.keyword{color:#0086b3}pre[data-line]{position:relative;padding:1em 0 1em 3em}pre[data-line] .line-highlight-wrapper{position:absolute;top:0;left:0;background-color:transparent;display:block;width:100%}pre[data-line] .line-highlight{position:absolute;left:0;right:0;padding:inherit 0;margin-top:1em;background:hsla(24,20%,50%,.08);background:linear-gradient(to right,hsla(24,20%,50%,.1) 70%,hsla(24,20%,50%,0));pointer-events:none;line-height:inherit;white-space:pre}pre[data-line] .line-highlight:before,pre[data-line] .line-highlight[data-end]:after{content:attr(data-start);position:absolute;top:.4em;left:.6em;min-width:1em;padding:0 .5em;background-color:hsla(24,20%,50%,.4);color:#f4f1ef;font:bold 65%/1.5 sans-serif;text-align:center;vertical-align:.3em;border-radius:999px;text-shadow:none;box-shadow:0 1px #fff}pre[data-line] .line-highlight[data-end]:after{content:attr(data-end);top:auto;bottom:.4em}html body{font-family:'Helvetica Neue',Helvetica,'Segoe UI',Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ol,html body>ul{margin-bottom:16px}html body ol,html body ul{padding-left:2em}html body ol.no-list,html body ul.no-list{padding:0;list-style-type:none}html body ol ol,html body ol ul,html body ul ol,html body ul ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:700;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:700}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::after,html body code::before{letter-spacing:-.2em;content:'\00a0'}html body pre>code{padding:0;margin:0;word-break:normal;white-space:pre;background:0 0;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:after,html body pre code:before,html body pre tt:after,html body pre tt:before{content:normal}html body blockquote,html body dl,html body ol,html body p,html body pre,html body ul{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body code,html body pre{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview ul{list-style:disc}.markdown-preview ul ul{list-style:circle}.markdown-preview ul ul ul{list-style:square}.markdown-preview ol{list-style:decimal}.markdown-preview ol ol,.markdown-preview ul ol{list-style-type:lower-roman}.markdown-preview ol ol ol,.markdown-preview ol ul ol,.markdown-preview ul ol ol,.markdown-preview ul ul ol{list-style-type:lower-alpha}.markdown-preview .newpage,.markdown-preview .pagebreak{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center!important}.markdown-preview:not([data-for=preview]) .code-chunk .code-chunk-btn-group{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .status{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .output-div{margin-bottom:16px}.markdown-preview .md-toc{padding:0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link div,.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}.markdown-preview .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0;min-height:100vh}@media screen and (min-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{font-size:14px!important;padding:1em}}@media print{html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc{padding:0 16px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link div,html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% - 300px);padding:2em calc(50% - 457px - 300px / 2);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */
.markdown-preview.markdown-preview {
  /* 个性化字体 */
  /* 限制代码块最大高度 */
  /* 更改标题色 */
  /* 更改标题大小 */
}
.markdown-preview.markdown-preview VT,
.markdown-preview.markdown-preview vt {
  color: #7e0062;
}
.markdown-preview.markdown-preview GN,
.markdown-preview.markdown-preview gn {
  color: #4a7500;
}
.markdown-preview.markdown-preview RD,
.markdown-preview.markdown-preview rd {
  color: #ff0000;
}
.markdown-preview.markdown-preview DRD,
.markdown-preview.markdown-preview drd {
  color: #83000f;
}
.markdown-preview.markdown-preview BL,
.markdown-preview.markdown-preview bl {
  color: #2d0081;
}
.markdown-preview.markdown-preview YL,
.markdown-preview.markdown-preview yl {
  color: #b47900;
}
.markdown-preview.markdown-preview BG,
.markdown-preview.markdown-preview bg {
  font-size: 1.25em;
}
.markdown-preview.markdown-preview BBG,
.markdown-preview.markdown-preview bbg {
  font-size: 1.5em;
}
.markdown-preview.markdown-preview BBBG,
.markdown-preview.markdown-preview bbbg {
  font-size: 2em;
}
.markdown-preview.markdown-preview T,
.markdown-preview.markdown-preview t {
  font-size: 2.5em;
}
.markdown-preview.markdown-preview pre {
  max-height: 515px;
  overflow: auto;
}
.markdown-preview.markdown-preview h1,
.markdown-preview.markdown-preview h2,
.markdown-preview.markdown-preview h3,
.markdown-preview.markdown-preview h4,
.markdown-preview.markdown-preview h5,
.markdown-preview.markdown-preview h6 {
  color: #0857a5;
}
.markdown-preview.markdown-preview h1 {
  font-size: 2em;
}
.markdown-preview.markdown-preview h2 {
  font-size: 1.5em;
}
.markdown-preview.markdown-preview h3,
.markdown-preview.markdown-preview h4,
.markdown-preview.markdown-preview h5,
.markdown-preview.markdown-preview h6 {
  font-size: 1.15em;
}

      </style>
      <!-- The content below will be included at the end of the <head> element. --><script type="text/javascript">
  document.addEventListener("DOMContentLoaded", function () {
    // your code here
  });
</script></head><body for="html-export">
    
    
      <div class="crossnote markdown-preview  ">
      
<p><strong></strong></p><center><strong><bbbg>1_基础</bbbg></strong></center><p></p>
<ul>
<li><a href="#%E5%9F%BA%E7%A1%80%E4%B8%AD%E7%9A%84%E5%9F%BA%E7%A1%80">基础中的基础</a></li>
<li><a href="#%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B">数据类型</a>
<ul>
<li><a href="#number">number</a></li>
<li><a href="#string">string</a></li>
<li><a href="#table">table</a></li>
<li><a href="#function">function</a>
<ul>
<li><a href="#%E5%A4%9A%E8%BF%94%E5%9B%9E%E5%80%BC">多返回值</a></li>
<li><a href="#%E5%8F%98%E9%95%BF%E5%8F%82%E6%95%B0">变长参数</a></li>
<li><a href="#%E5%85%B7%E5%90%8D%E5%AE%9E%E5%8F%82">具名实参</a></li>
<li><a href="#unpack">unpack()</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#%E5%BA%93">库</a>
<ul>
<li><a href="#%E6%95%B0%E5%AD%A6%E5%BA%93math">数学库math</a></li>
<li><a href="#%E8%A1%A8%E5%BA%93table">表库table</a></li>
<li><a href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%BA%93string">字符串库string</a></li>
<li><a href="#io%E5%BA%93io">I/O库io</a></li>
<li><a href="#%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%BA%93os">操作系统库os</a></li>
<li><a href="#%E8%B0%83%E8%AF%95%E5%BA%93debug">调试库debug</a></li>
</ul>
</li>
</ul>
<h1 id="基础中的基础">基础中的基础 </h1>
<p><strong><bl>问题：Lua是什么</bl></strong><br>
<bl>Lua是一种轻量化的<em>嵌入式</em>语言，可以嵌入应用程序中，这意味着：在游戏中可以为本体进行灵活的扩展和定制功能</bl></p>
<p><strong>一些知识点：</strong></p>
<ul>
<li>
<p><strong><gn>chunk</gn></strong>---程序块，为<strong>一连串的语句或命令</strong></p>
</li>
<li>
<p>Lua<strong>区分大小写</strong></p>
</li>
<li>
<p>未初始化的变量可以直接访问，为nil</p>
</li>
<li>
<p>不添加前缀就是<b><gn>全局变量</gn></b>，添加local前缀就是<b><gn>局部变量</gn></b></p>
</li>
<li>
<p>索引起始值为1(否则某些机制无法使用)</p>
</li>
<li>
<p><code>a = a or 0</code>，一种<strong>默认值</strong>的设置方式</p>
</li>
<li>
<p><code>zip = (address or {}).zipcode</code>，一种<strong>类的安全访问</strong>的方式</p>
</li>
<li>
<p><code>x, y = y, x</code>，一种<strong>交换</strong>的方式</p>
</li>
<li>
<p>Lua支持多重赋值，如<code>a, b = 10, 2*10</code>　所以：<code>a,b,c = 0</code>是不对的，应该为<code>a,b,c = 0,0,0</code></p>
</li>
<li>
<p>通过<code>do ... end</code>添加块　　<vt>类似与C#的<code>{ ... }</code></vt><br>
由此可以创建出<strong>不污染全局的局部变量</strong>：</p>
<pre data-role="codeBlock" data-info="lua" class="language-lua lua"><code>foo <span class="token operator">=</span> <span class="token number">10</span>
<span class="token keyword keyword-do">do</span>
  <span class="token comment">--创建局部的foo，在此之后end之前foo都是局部的</span>
   <span class="token keyword keyword-local">local</span> foo <span class="token operator">=</span> foo
   foo <span class="token operator">=</span> <span class="token number">1</span>
   <span class="token function">print</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span> <span class="token comment">-- 局部，得1</span>
<span class="token keyword keyword-end">end</span>
<span class="token function">print</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span> <span class="token comment">-- 全局，得10</span>
</code></pre></li>
</ul>
<h1 id="数据类型">数据类型 </h1>
<p><strong>在Lua中有以下类型：</strong><br>
nil | boolean | number | string | userdata | function | thread | table</p>
<h2 id="number">number </h2>
<p><strong><drd>注意：从Lua5.3开始，number非拆分成了integer(整型)与float(浮点型)</drd></strong><br>
在5.3之前：<br>
所有数值都是<strong>双精度浮点格式</strong><br>
在5.3之后：<br>
integer-<strong>64位整型</strong> | float-<strong>双精度浮点类型</strong><br>
(可以通过Small Lua模式<vt>(好像是通过LUA_32BITS宏？)</vt>改用32位整型与单精度浮点类型)</p>
<p><strong>Tip：</strong></p>
<ul>
<li>
<p>可以通过<code>math.maxinteger</code>/<code>math.mininteger</code>表示整型的最大值/最小值</p>
</li>
<li>
<p>可以通过<code>math.huge</code>/<code>-math.huge</code>表示浮点型的最大值/最小值</p>
</li>
<li>
<p><strong>整型转浮点型</strong>可以通过**+0.0**　　　<yl>如：<code>-3+0.0为</code>-3.0`</yl></p>
</li>
<li>
<p><strong>浮点型转整型</strong>，有两种方式：按位或 | <code>math.tointeger()</code><br>
两种都会进行检查：</p>
<ul>
<li><code>2^53 | 0</code>为<code>9007199254740992</code></li>
<li><code>3.2 | 0</code>　　　<vt>不可以，因为3.2和3不相等</vt></li>
<li><code>2^64 | 0</code>　　　<vt>不可以，超范围了</vt></li>
</ul>
</li>
<li>
<p>大于2^53的整型转浮点型会造成精度损失</p>
</li>
<li>
<p>浮点型强转整型的话可以改造以下函数：</p>
<pre data-role="codeBlock" data-info="lua" class="language-lua lua"><code><span class="token keyword keyword-function">function</span> <span class="token function">cond2int</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    <span class="token comment">-- 转换失败会返回nil，那么失败就还原</span>
    <span class="token keyword keyword-return">return</span> math<span class="token punctuation">.</span><span class="token function">tointeger</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token keyword keyword-or">or</span> x
<span class="token keyword keyword-end">end</span>
</code></pre></li>
</ul>
<p><strong>优先级</strong>如下所示：　　<strong><vt>优先级从高到低</vt></strong><br>
<img src="Pic/%E4%BC%98%E5%85%88%E7%BA%A7.png" alt="优先级"><br>
<strong>结合律</strong>如下所示：<br>
<strong>除了<code>^</code>和<code>..</code>为右结合，其余皆为左结合</strong></p>
<h2 id="string">string </h2>
<p>单行注释---<code>--</code><br>
多行注释---<code>[[ ... ]]</code>　　<vt>类似与C#的<code>@</code></vt></p>
<ul>
<li><strong>string转其它类型</strong>---toXXX()　　<yl>如：<code>tonumber()</code></yl></li>
<li><strong>其它类型转string</strong>：
<ul>
<li><code>tostring()</code></li>
<li><code>xx .. ""</code>　　<vt>即<b>添加空字符串</b></vt></li>
</ul>
</li>
</ul>
<p>对于string来说，有<strong>2个库</strong>：</p>
<ul>
<li><strong><gn>string库</gn></strong>---<vt>对ASCII操作</vt></li>
<li><strong><gn>utf8库</gn></strong>---<vt>对utf8操作</vt>　<strong>lua5.3新增</strong></li>
</ul>
<p><strong><drd>注意：string库的内容还是可以用于utf8字符串的，只是形式有所变化(如：<code>string.len()</code>会以字节为单位)</drd></strong></p>
<h2 id="table">table </h2>
<p>table具有<strong>唯一的创建方式</strong>，即<code>{}</code><br>
具体来说有：</p>
<ul>
<li>1.<code>days = {"Sunday", "Monday"}</code></li>
<li>2.<code>a = {x=10, y=20}</code></li>
<li>3.<code>opnames = {["+"] = "add", ["-"] = "sub"}</code> 可以使用负数</li>
</ul>
<p>我们可以认为1/2形式其实是3形式的<strong>语法糖</strong></p>
<p><strong>语法糖：</strong><code>a["name"] == a.name</code>　　<strong><drd>注意：是a["name"]而非a[name]</drd></strong></p>
<p><strong><vt>问题：如何以索引0开始</vt></strong><br>
<code>{[0] = 0, 1, 2, 3, 4}</code>　　<strong><drd>注意：极其不推荐，因为有些内容需要起始索引为1的特性</drd></strong></p>
<p><strong>Tip：分割不仅可以是<code>,</code>，还可以是<code>;</code></strong>，在某些时候可以起到小分割与大分割的作用<br>
<strong><yl>如：</yl></strong><code>t = {x=10, y=45; "one", "two", "three"}</code></p>
<p><strong>nil是数组结尾的标志</strong>，有：</p>
<pre data-role="codeBlock" data-info="lua" class="language-lua lua"><code>a <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
a<span class="token punctuation">[</span><span class="token number">10000</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token operator">#</span>a<span class="token punctuation">)</span> <span class="token comment">-- 0，按理来说应该是1</span>
</code></pre><p>由此，我们可以编写一个<b><gn>长度函数len()</gn></b>:</p>
<pre data-role="codeBlock" data-info="lua" class="language-lua lua"><code><span class="token comment">-- 通过pairs进行完整遍历，输出完整长度</span>
<span class="token keyword keyword-local">local</span> <span class="token keyword keyword-function">function</span> <span class="token function">len</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    <span class="token keyword keyword-local">local</span> n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-for">for</span> k<span class="token punctuation">,</span>v <span class="token keyword keyword-in">in</span> <span class="token function">pairs</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token keyword keyword-do">do</span>
        n <span class="token operator">=</span> n <span class="token operator">+</span> <span class="token number">1</span>
    <span class="token keyword keyword-end">end</span>
    <span class="token keyword keyword-return">return</span> n
<span class="token keyword keyword-end">end</span>
</code></pre><h2 id="function">function </h2>
<p>一般函数的形式为：<code>print("OK")</code><br>
但是存在一种<strong>特例</strong>：<strong><vt>如果函数只有一个参数(必须是<drd>字面字符串或table构造式</drd>)，那么可以省略括号(指的是调用时只有一个)</vt></strong><br>
<strong><yl>如：</yl></strong><code>print("OK")</code>---&gt;<code>print "OK"</code>　<code>require("a")</code>---&gt;<code>require "a"</code></p>
<p>在Lua中，<strong>参数列表是不需要匹配</strong>的：</p>
<ul>
<li>假如多传参了，那么多的就会丢弃，</li>
<li>假如少传参了，那么少的就会置为nil</li>
</ul>
<p>由此可以应用在如下情况：</p>
<pre data-role="codeBlock" data-info="lua" class="language-lua lua"><code><span class="token keyword keyword-function">function</span> <span class="token function">incCount</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>
  <span class="token comment">-- n可以不传，不传就设默认值1</span>
  n <span class="token operator">=</span> n <span class="token keyword keyword-or">or</span> <span class="token number">1</span>
  count <span class="token operator">=</span> count <span class="token operator">+</span> n
<span class="token keyword keyword-end">end</span>
</code></pre><h3 id="多返回值">多返回值 </h3>
<p><code>function foo() return "a", "b" end</code><br>
<strong>关键点：<vt>如果函数调用不是表达式的最后一个元素，那么只产生一个值(对于table初始化来说同理)</vt></strong></p>
<pre data-role="codeBlock" data-info="lua" class="language-lua lua"><code><span class="token keyword keyword-function">function</span> <span class="token function">foo0</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword keyword-end">end</span>
<span class="token keyword keyword-function">function</span> <span class="token function">foo2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword keyword-return">return</span> <span class="token string">"a"</span><span class="token punctuation">,</span> <span class="token string">"b"</span> <span class="token keyword keyword-end">end</span>

x <span class="token operator">=</span> <span class="token function">foo2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">-- x="a"，"b"被丢弃</span>
x<span class="token punctuation">,</span>y<span class="token punctuation">,</span>z <span class="token operator">=</span> <span class="token function">foo2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">-- x="a"，y="b"，z未赋值为nil</span>

x<span class="token punctuation">,</span>y <span class="token operator">=</span> <span class="token function">foo2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">20</span> <span class="token comment">-- x="a"(只取第一个"a"，"b"被丢弃了)， y=20</span>
x<span class="token punctuation">,</span>y <span class="token operator">=</span> <span class="token function">foo0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">30</span> <span class="token comment">-- x=nil(foo0赋值的)，y=20，30被丢弃</span>

<span class="token function">print</span><span class="token punctuation">(</span><span class="token function">foo2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">-- a b</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token function">foo2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">-- a 1</span>

<span class="token comment">-- table同理</span>
t <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token function">foo0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">foo2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">}</span> <span class="token comment">-- [1]=nil [2]="a" [3]=4</span>
</code></pre><p><strong>Tip：括号能使多返回值函数只返回1个值</strong></p>
<pre data-role="codeBlock" data-info="lua" class="language-lua lua"><code><span class="token keyword keyword-function">function</span> <span class="token function">multipleReturns</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span>
<span class="token keyword keyword-end">end</span>
<span class="token keyword keyword-local">local</span> t1 <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token function">multipleReturns</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>  <span class="token comment">-- t1 = {1, 2, 3}</span>
<span class="token keyword keyword-local">local</span> t2 <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token function">multipleReturns</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span>  <span class="token comment">-- t2 = {1}</span>

<span class="token comment">-- 实用例子</span>
<span class="token keyword keyword-local">local</span> s <span class="token operator">=</span> <span class="token string">"Hello, world!"</span>
<span class="token keyword keyword-local">local</span> firstComma <span class="token operator">=</span> <span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">-- 只返回第一个分割字符串</span>
<span class="token function">print</span><span class="token punctuation">(</span>firstComma<span class="token punctuation">)</span>  <span class="token comment">-- 输出: 6</span>
</code></pre><h3 id="变长参数">变长参数 </h3>
<p>简单来说，变长参数就是<code>...</code></p>
<pre data-role="codeBlock" data-info="lua" class="language-lua lua"><code><span class="token comment">-- 加法函数</span>
<span class="token keyword keyword-function">function</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">...</span><span class="token punctuation">)</span>
  <span class="token keyword keyword-local">local</span> s <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token keyword keyword-for">for</span> i<span class="token punctuation">,</span>v <span class="token keyword keyword-in">in</span> <span class="token function">ipairs</span><span class="token punctuation">{</span><span class="token punctuation">...</span><span class="token punctuation">}</span> <span class="token keyword keyword-do">do</span>
    s <span class="token operator">=</span> s <span class="token operator">+</span> v
  <span class="token keyword keyword-end">end</span>
  <span class="token keyword keyword-return">return</span> s
<span class="token keyword keyword-end">end</span>

<span class="token function">print</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">-- 54</span>
</code></pre><p><strong><bl>问题：为什么可以是<code>ipairs{...}</code>，不应该是<code>ipairs(table)</code>吗</bl></strong><br>
<bl>在前面我们提到过如果只有一个参数是可以省略括号的，那么本质上这其实是<code>ipairs({...})</code>，也就是<b>构建了一个table传入</b>，那么我们也能发现：<strong><vt><code>ipairs</code>其实是一个函数</vt></strong></bl></p>
<p><strong>两种逻辑：</strong></p>
<ul>
<li><code>local a, b = ...</code>---多返回值</li>
<li><code>{...}</code>---多返回值组成table</li>
</ul>
<p><strong><yl>用处：</yl></strong></p>
<pre data-role="codeBlock" data-info="lua" class="language-lua lua"><code><span class="token comment">-- 1.跟踪函数</span>
<span class="token comment">-- 相当于嵌套了一层，可以再运行前先进行一定的操作</span>
<span class="token keyword keyword-function">function</span> <span class="token function">foo1</span><span class="token punctuation">(</span><span class="token punctuation">...</span><span class="token punctuation">)</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"calling foo:"</span><span class="token punctuation">,</span> <span class="token punctuation">...</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">...</span><span class="token punctuation">)</span>
<span class="token keyword keyword-end">end</span>

<span class="token comment">-- 2.组合</span>
<span class="token comment">-- io.write():一种更原始的print()，不会添加换行符，</span>
<span class="token comment">-- 也不会在参数间添加制表符，也不会自动刷新缓冲区(换行就会刷新(好像))</span>
<span class="token keyword keyword-function">function</span> <span class="token function">fwrite</span><span class="token punctuation">(</span>fmt<span class="token punctuation">,</span> <span class="token punctuation">...</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span> io<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>fmt<span class="token punctuation">,</span> <span class="token punctuation">...</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword keyword-end">end</span>

<span class="token function">fwrite</span><span class="token punctuation">(</span><span class="token string">"%d%d"</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token comment">-- 输出45</span>
</code></pre><p>对于变长参数来说，有一函数会比较有用，即<b><code>select()</code></b>：</p>
<ul>
<li><code>select("#", ...)</code>　　　 <vt>此时，会获取参数数量</vt></li>
<li><code>select(n, ...)</code>　　　　<vt>此时，会返回从n开始的所有参数</vt></li>
</ul>
<pre data-role="codeBlock" data-info="lua" class="language-lua lua"><code><span class="token comment">-- 从第1个元素开始，遍历到底，每次都通过select(i, ...)取出第i个元素</span>
<span class="token comment">-- 假设有12345，i=1时会得到12345，但是只有一个arg需要接收，那么就是第一个元素1</span>
<span class="token keyword keyword-for">for</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token function">select</span><span class="token punctuation">(</span><span class="token string">"#"</span><span class="token punctuation">,</span> <span class="token punctuation">...</span><span class="token punctuation">)</span> <span class="token keyword keyword-do">do</span>
    <span class="token keyword keyword-local">local</span> arg <span class="token operator">=</span> <span class="token function">select</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token punctuation">...</span><span class="token punctuation">)</span>
    <span class="token comment">-- ...</span>
<span class="token keyword keyword-end">end</span>
</code></pre><h3 id="具名实参">具名实参 </h3>
<p>在C#中，是具有具名实参的：</p>
<pre data-role="codeBlock" data-info="csharp" class="language-csharp csharp"><code><span class="token keyword keyword-public">public</span> <span class="token return-type class-name"><span class="token keyword keyword-void">void</span></span> <span class="token function">Rename</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword keyword-string">string</span></span> oldName<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword keyword-string">string</span></span> newName<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">/*...*/</span><span class="token punctuation">}</span>

<span class="token comment">//使用</span>
<span class="token function">Rename</span><span class="token punctuation">(</span><span class="token named-parameter punctuation">oldName</span><span class="token punctuation">:</span> <span class="token string">"A"</span><span class="token punctuation">,</span> <span class="token named-parameter punctuation">newName</span><span class="token punctuation">:</span> <span class="token string">"newA"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>而在lua中，是通过<strong>表的特性</strong>来完成的：</p>
<pre data-role="codeBlock" data-info="lua" class="language-lua lua"><code><span class="token keyword keyword-function">function</span> <span class="token function">rename</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span> os<span class="token punctuation">.</span><span class="token function">rename</span><span class="token punctuation">(</span>arg<span class="token punctuation">.</span>old<span class="token punctuation">,</span> arg<span class="token punctuation">.</span>new<span class="token punctuation">)</span>
<span class="token keyword keyword-end">end</span>

<span class="token function">rename</span><span class="token punctuation">{</span>old<span class="token operator">=</span><span class="token string">"old.lua"</span><span class="token punctuation">,</span> new<span class="token operator">=</span><span class="token string">"new.lua"</span><span class="token punctuation">}</span>
</code></pre><p>所以说：<strong>与其说是具名实参，不如说这是唯一用法，一种用table包装的方式</strong><br>
所以说：如果参数传入数量不定，这会是一种很好的方式</p>
<pre data-role="codeBlock" data-info="lua" class="language-lua lua"><code><span class="token keyword keyword-function">function</span> <span class="token function">Window</span> <span class="token punctuation">(</span>options<span class="token punctuation">)</span>
    <span class="token comment">-- 检查必要的参数</span>
    <span class="token keyword keyword-if">if</span> <span class="token function">type</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>title<span class="token punctuation">)</span> <span class="token operator">~=</span> <span class="token string">"string"</span> <span class="token keyword keyword-then">then</span>
        <span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"no title"</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-elseif">elseif</span> <span class="token function">type</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>width<span class="token punctuation">)</span> <span class="token operator">~=</span> <span class="token string">"number"</span> <span class="token keyword keyword-then">then</span>
        <span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"no width"</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-elseif">elseif</span> <span class="token function">type</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>height<span class="token punctuation">)</span> <span class="token operator">~=</span> <span class="token string">"number"</span> <span class="token keyword keyword-then">then</span>
        <span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"no height"</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-end">end</span>
    
    <span class="token comment">-- 其他参数都是可选的</span>
    <span class="token function">_Window</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>title<span class="token punctuation">,</span>
            options<span class="token punctuation">.</span>x <span class="token keyword keyword-or">or</span> <span class="token number">0</span><span class="token punctuation">,</span>        <span class="token comment">-- 默认值</span>
            options<span class="token punctuation">.</span>y <span class="token keyword keyword-or">or</span> <span class="token number">0</span><span class="token punctuation">,</span>        <span class="token comment">-- 默认值</span>
            options<span class="token punctuation">.</span>width<span class="token punctuation">,</span> options<span class="token punctuation">.</span>height<span class="token punctuation">,</span>
            options<span class="token punctuation">.</span>background <span class="token keyword keyword-or">or</span> <span class="token string">"white"</span><span class="token punctuation">,</span>  <span class="token comment">-- 默认值</span>
            options<span class="token punctuation">.</span>border         <span class="token comment">-- 默认值为false (nil)</span>
    <span class="token punctuation">)</span>
<span class="token keyword keyword-end">end</span>
</code></pre><h3 id="unpack">unpack() </h3>
<p>简单来说，该函数就是用于<strong>table转多返回值的</strong><br>
<yl><b>举个例子</b>的话就是：<code>string.find()</code>需要多参数，但我手上可能有一个table，使用<code>unpack()</code>即可转换为多参数，可能有<code>string.find(unpack({"hello", "ll"}))</code></yl><br>
虽然<code>unpack()</code>由C实现，但在<strong>Lua</strong>中我们也可以<strong>实现</strong>：</p>
<pre data-role="codeBlock" data-info="lua" class="language-lua lua"><code><span class="token comment">-- 大致就是：</span>
<span class="token comment">-- 我们使用unpack(t)，然后取i再递归看看i+1有没有</span>
<span class="token keyword keyword-function">function</span> <span class="token function">unpack</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> i<span class="token punctuation">)</span>
    i <span class="token operator">=</span> i <span class="token keyword keyword-or">or</span> <span class="token number">1</span>
    <span class="token keyword keyword-if">if</span> t<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword keyword-then">then</span>
        <span class="token keyword keyword-return">return</span> t<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token function">unpack</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-end">end</span>
<span class="token keyword keyword-end">end</span>
</code></pre><h1 id="库">库 </h1>
<p><strong>常用的库</strong>有：</p>
<ul>
<li>数学库math</li>
<li>表库table</li>
<li>字符串库string</li>
<li>I/O库io</li>
<li>操作系统库os</li>
<li>调试库debug</li>
</ul>
<br>
<h2 id="数学库math">数学库math </h2>
<p><strong>大致有：</strong></p>
<ul>
<li>三角函数---<code>sin()</code> <code>cos()</code> <code>tan()</code> <code>asin()</code> <code>acos()</code> <code>atan()</code>
<ul>
<li><code>deg()</code> <code>rad()</code>　　<vt>角度制弧度制转换，<b>默认弧度制</b></vt></li>
</ul>
</li>
<li>指数/对数函数---<code>exp()</code> <code>log()</code> <code>log10()</code></li>
<li>取整函数---<code>floor()</code> <code>ceil()</code> <code>modf()</code>
<ul>
<li><code>floor()</code>向下取整，<code>ceil()</code>向上取整，<code>modf()</code>向0取整</li>
<li><code>modf()</code>会返回<b>2个值(整数部分与小数部分(即余数))，<yl>举例：</yl></b>
<ul>
<li><code>math.modf(3.3)</code> 返回<code>3 0.3</code></li>
<li><code>math.modf(-3.3)</code> 返回<code>-3 -0.3</code></li>
</ul>
</li>
</ul>
</li>
<li>随机函数---<code>random()</code> <code>randomseed()</code>
<ul>
<li>random函数是<strong>均匀分布，伪随机</strong>的
<ul>
<li><code>random()</code>：取值范围[0,1)</li>
<li><code>random(n)</code>：取值范围[1,n]</li>
<li><code>random(l,u)</code>：取值范围[l,u]</li>
</ul>
</li>
<li>randomseed函数为<vt><b>random函数计算额外的种子</b></vt>，<strong>默认为1</strong><br>
这会导致每次运算必然得到同一结果，所以<strong>解决方法</strong>就是：<code>math.randomseed(os.time())</code>，这样由于系统时间每次都不同，从而种子不同，运算结果也不同</li>
</ul>
</li>
<li><code>max()</code> <code>min()</code></li>
<li><code>pi</code></li>
<li><code>huge</code>即<strong>inf</strong></li>
</ul>
<h2 id="表库table">表库table </h2>
<p><strong>大致有：</strong>　　<vt>表库是一个<b>提供List操作</b>的库</vt></p>
<ul>
<li>
<p>插入与删除---<code>insert()</code> <code>remove()</code> <code>move()</code>-5.3追加</p>
<ul>
<li>
<p><code>insert(table, value)</code>：在末尾添加value元素</p>
</li>
<li>
<p><code>insert(table, pos, value)</code>：在pos处插入value元素(pos及之后的元素向后移动1格)</p>
</li>
<li>
<p><code>remove(table)</code>：删除末尾元素</p>
</li>
<li>
<p><code>remove(table, pos)</code>：删除pos处元素(pos之后的元素向前移动1格)</p>
</li>
<li>
<p><code>move(a,f,e,t)</code>：将表a中从索引f到e的元素移动到位置t上<br>
可以有：</p>
<pre data-role="codeBlock" data-info="lua" class="language-lua lua"><code><span class="token comment">-- 在开头插入一个元素</span>
table<span class="token punctuation">.</span><span class="token function">move</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">#</span>a<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
a<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> newElement

<span class="token comment">--删除首元素</span>
table<span class="token punctuation">.</span><span class="token function">move</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">#</span>a<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
a<span class="token punctuation">[</span><span class="token operator">#</span>a<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword keyword-nil">nil</span>
</code></pre></li>
<li>
<p><code>move(a,f,e,t,a2)</code>：将表a中从索引f到e的元素移动到表a2的位置t上</p>
</li>
</ul>
</li>
<li>
<p>排序<code>sort()</code></p>
<ul>
<li>
<p><code>sort(table)</code>：排序，<strong><vt>默认升序</vt></strong></p>
</li>
<li>
<p><code>sort(table, comp)</code>：根据<strong>比较函数comp</strong>进行排序　类似于C#的IComparer接口</p>
</li>
<li>
<p><strong><drd>重要：排序是对table的value进行排序</drd></strong><br>
这意味着如果有以下table，我们如果想以字母次序排序，直接进行时错误的：</p>
<pre data-role="codeBlock" data-info="lua" class="language-lua lua"><code>lines <span class="token operator">=</span> <span class="token punctuation">{</span>
  luaH_set <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">,</span>
  luaH_get <span class="token operator">=</span> <span class="token number">24</span><span class="token punctuation">,</span>
  luaH_present <span class="token operator">=</span> <span class="token number">48</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><p>如果想要这样排序，则需要：</p>
<ul>
<li>重新建一个value为名字的数组进行排序</li>
<li>迭代器</li>
</ul>
<pre data-role="codeBlock" data-info="lua" class="language-lua lua"><code><span class="token comment">-- 方法1：</span>
keys <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword keyword-for">for</span> k <span class="token keyword keyword-in">in</span> <span class="token function">pairs</span><span class="token punctuation">(</span>lines<span class="token punctuation">)</span> <span class="token keyword keyword-do">do</span> keys<span class="token punctuation">[</span><span class="token operator">#</span>keys<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> k <span class="token keyword keyword-end">end</span>
table<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>keys<span class="token punctuation">)</span>
<span class="token comment">-- 注意：对于ipairs来说绝对是顺序的</span>
<span class="token keyword keyword-for">for</span> _<span class="token punctuation">,</span>k <span class="token keyword keyword-in">in</span> <span class="token function">ipairs</span><span class="token punctuation">(</span>keys<span class="token punctuation">)</span> <span class="token keyword keyword-do">do</span> <span class="token function">print</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span>lines<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword keyword-end">end</span>

<span class="token comment">--方法2：</span>
<span class="token comment">--和方法1一个意思，就是闭包了一个表a</span>
<span class="token keyword keyword-function">function</span> <span class="token function">pairsByKeys</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> f<span class="token punctuation">)</span>
  <span class="token keyword keyword-local">local</span> a <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword keyword-for">for</span> n <span class="token keyword keyword-in">in</span> <span class="token function">pairs</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span> <span class="token keyword keyword-do">do</span> a<span class="token punctuation">[</span><span class="token operator">#</span>a <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> n <span class="token keyword keyword-end">end</span>
  table<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> f<span class="token punctuation">)</span>
  <span class="token keyword keyword-local">local</span> i <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-function">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    i <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span>
    <span class="token keyword keyword-return">return</span> a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> t<span class="token punctuation">[</span>a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span>
  <span class="token keyword keyword-end">end</span>
<span class="token keyword keyword-end">end</span>

<span class="token keyword keyword-for">for</span> name<span class="token punctuation">,</span> line <span class="token keyword keyword-in">in</span> <span class="token function">pairsByKeys</span><span class="token punctuation">(</span>lines<span class="token punctuation">)</span> <span class="token keyword keyword-do">do</span>
  <span class="token function">print</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> line<span class="token punctuation">)</span>
<span class="token keyword keyword-end">end</span>
</code></pre></li>
</ul>
</li>
<li>
<p>拼接<code>concat()</code></p>
</li>
<li>
<p>打包解包<code>pack()</code> <code>unpack()</code></p>
</li>
</ul>
<h2 id="字符串库string">字符串库string </h2>
<p><strong>大概有：</strong></p>
<ul>
<li>
<p><code>len(s)</code>：返回字符串s的长度，等价于<code>#s</code></p>
</li>
<li>
<p><code>rep(s,n)</code>：即repeat，重复字符串s n次</p>
</li>
<li>
<p><code>reverse()</code>：翻转</p>
</li>
<li>
<p><code>lower(s)</code> <code>upper(s)</code>：返回s的小写版/大写版副本</p>
</li>
<li>
<p><code>sub(s,i,j)</code>：即子字符串的含义，为提取s中的索引i到j的字符<vt>(<b>支持负索引</b>，如-1为最后一个字符，-2为倒数第二个字符)</vt></p>
<pre data-role="codeBlock" data-info="lua" class="language-lua lua"><code>s <span class="token operator">=</span> "<span class="token punctuation">[</span><span class="token keyword keyword-in">in</span> brackets<span class="token punctuation">]</span>
string<span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">-- in brackets</span>
string<span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">-- [</span>
string<span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">-- ]</span>
</code></pre><p><drd>注意：和C#一样，是复制，所以需要赋值给原变量，即：<code>s = string.sub(s, ., .)</code></drd></p>
</li>
<li>
<p>转换函数---<code>char()</code> <code>byte()</code></p>
<ul>
<li><code>char(i)</code>：ASCII码转字符</li>
<li><code>char(...)</code>：ASCII码转字符，并连成字符串</li>
<li><code>byte(s)</code>：字符转ASCII码，取第一个字符　<vt>即i默认为1</vt></li>
<li><code>byte(s,i)</code>：字符转ASCII码，取第i个字符</li>
<li><code>byte(s,i,j)</code>：字符转ASCII码，取索引i到j中的字符</li>
</ul>
</li>
<li>
<p><code>format()</code>：格式化字符串</p>
<ul>
<li>大致形式有：<code>string.format("x = %d", 10)</code>　<vt>与C的printf()非常像</vt></li>
<li>有控制格式细节，如：<code>%.4f</code>为4位小数 <code>%02d</code>为2位整数(不足补0)</li>
<li><strong>其实就是调用C语言的printf函数完成的</strong></li>
</ul>
</li>
<li>
<p>模式匹配函数---<code>find()</code> <code>match()</code> <code>gsub()</code> <code>gmatch()</code></p>
<ul>
<li><code>find(str,pattern[,init[,plain]])</code>：从init(默认位1)开始寻找，在str中查找pattern子串或模式，返回找到元素的首尾索引
<ul>
<li>plain：是否开启简单搜索，默认关闭，即开启模式匹配(类似于正则表达式)</li>
<li><yl>举个例子：<code>string.find("a [word]", "[")</code>这是错误的，因为默认会认为<code>[</code>是模式匹配的一部分<br>
如果想要搜索左括号，那么将plain设为true即可</yl></li>
</ul>
</li>
<li><code>match(str,pattern[,init])</code>：同find()，只是返回的是匹配的子串</li>
<li><code>gsub(str,pattern,repl[,n])</code>：将匹配的pattern替换为repl，返回替换后的字符串与替换的次数
<ul>
<li>n：限制替换的次数</li>
</ul>
</li>
<li><code>gmatch(s,pattern)</code>：在s中寻找pattern，返回一个迭代器函数返回匹配结果</li>
</ul>
</li>
</ul>
<h2 id="io库io">I/O库io </h2>
<p><strong>大概有：</strong></p>
<ul>
<li><strong>简单I/O模型　　<vt>仅能处理单输入输出</vt></strong>
<ul>
<li><code>input()</code> <code>output()</code>：
<ul>
<li>无参形式<code>input()</code> <code>output()</code>：获取当前输入输出流</li>
<li>有参形式<code>input(f)</code> <code>output(f)</code>：更改当前输入输出流，一旦更改，之后的所有输入输出都会来自于对应文件　　<vt>会抛出异常，但是想要直接处理异常需要完整I/O模型</vt></li>
</ul>
</li>
<li><code>write()</code>：读取任意多个字符串或数字并写入当前输出流
<ul>
<li><vt>Tip：<b>由于可以传入多个参数</b>，所以应该避免使用<code>..</code>连接符改用多参数形式，如：<code>(a..b..c)</code>---&gt;<code>(a,b,c)</code></vt></li>
<li><vt>Tip2：<b>除非用于调试或"用后即弃"该用<code>print()</code>，其余时候都应该使用<code>write()</code>(因为write更原始一点)</b></vt></li>
</ul>
</li>
<li><code>read()</code>：从当前流读取字符串
<ul>
<li>格式参数决定了读取的数据：
<ul>
<li><code>"a"</code>---整个文件</li>
<li><code>"l"</code>---下一行(丢弃换行符)　　<strong>默认参数</strong></li>
<li><code>"L"</code>---下一行(保留换行符)</li>
<li><code>"n"</code>---一个数值</li>
<li><code>num</code>---以字符串读取num个字符
<ul>
<li><code>io.read(0)</code>可以<strong>测试是否到达文件末尾</strong>，有数据则为空字符串，否则为nil</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><code>lines()</code>：迭代器函数，用于逐行迭代文件<vt>(<code>read("l")</code>如果要全读还不如使用<code>lines()</code>)</vt>
<ul>
<li><code>lines()</code>：即<code>io.input():lines()</code></li>
<li><code>lines(f)</code>：以<strong>只读</strong>的方式打开对应文件的输入流，达到末尾后<strong>自动关闭</strong></li>
<li><strong><vt>在lua5.2开始，可以接收<code>read()</code>一样的格式参数(如<code>"a"</code>)</vt></strong></li>
</ul>
</li>
</ul>
</li>
<li><strong>完整I/O模型　　<vt>支持多输入输出</vt></strong>
<ul>
<li><code>open()</code>：打开一个文件，返回对应文件的流，发生错误则返回nil与错误信息+错误码　　<vt>类似于C的<code>fopen()</code></vt>
<ul>
<li>模式参数决定了文件的性质：
<ul>
<li><code>"r"</code>---只读</li>
<li><code>"w"</code>---只写</li>
<li><code>"a"</code>---追加(从末尾添加)</li>
<li><code>"b"</code>---表示打开二进制文件</li>
</ul>
</li>
<li><code>open()</code>与<code>assert()</code>的协作：<br>
由于<code>open()</code>在错误时会返回错误信息+错误码，所以正好与<code>assert()</code>的第二个参数message即错误信息相对应<br>
可以有：<code>assert(io.open(filename,mode))</code></li>
</ul>
</li>
<li><code>read()</code> <code>write()</code>：读写，<strong>在打开文件后进行</strong>　<yl>通常为<code>f:read("a")</code>(f为流)</yl>　　<vt>Tip：完整模型是<b>针对文件的操作</b>，即<code>file:xxx()</code>而非<code>io.xxx()</code></vt>
<ul>
<li><code>stdin</code> <code>stdout</code> <code>stderr</code>：句柄，用于写入不同的流(输入/输出/错误)，通常是<strong>命令行</strong>
<ul>
<li>大致用法为：<code>io.stderr:write(message)</code></li>
</ul>
</li>
<li><vt>Tip：<code>io.read(args)</code>是<code>io.input():read(arg)</code>的<b>缩写</b></vt></li>
</ul>
</li>
<li><code>tmpfile()</code>：返回一个<strong>读写模式的句柄</strong>，用于操作临时文件，程序运行结束后会自动删除　　<vt>很像内存流(但不是)</vt></li>
<li><code>flush()</code>：将所有缓冲数据写入文件，同样有<code>io.flush()</code>和<code>f:flush()</code></li>
<li><code>setvbuf()</code>：设置流的缓冲模式
<ul>
<li>参数1<code>mode</code>：就是缓冲模式
<ul>
<li><code>"no"</code>---无缓冲，即立即写入</li>
<li><code>"full"</code>---完全缓冲，即满了写入</li>
<li><code>"line"</code>---行缓冲，即换行写入</li>
</ul>
</li>
<li>参数2<code>size</code>：缓冲区大小，默认由系统决定</li>
</ul>
</li>
<li><code>seek()</code>：获取和设置文件的当前位置
<ul>
<li>参数1<code>whence</code>：如何计算偏移　　<strong><vt>以字节为单位</vt></strong>
<ul>
<li><code>"set"</code>---开头偏移</li>
<li><code>"cur"</code>---当前位置偏移　<strong>默认值</strong></li>
<li><code>"end"</code>---末尾偏移</li>
</ul>
</li>
<li>参数2<code>offset</code>：偏移</li>
</ul>
</li>
</ul>
</li>
<li><strong>其它</strong>
<ul>
<li><code>popen()</code>：与<code>os.execute()</code>类似，运行系统命令并重定向命令的输入/输出
<ul>
<li>
<p>参数1<code>command</code>：执行的命令</p>
</li>
<li>
<p>参数2<code>mode</code>：模式，具有<code>"r"</code>读模式以及<code>"w"</code>写模式</p>
</li>
<li>
<p>举个例子有：</p>
<pre data-role="codeBlock" data-info="lua" class="language-lua lua"><code><span class="token comment">-- 以sort的方式进行write()操作</span>
<span class="token keyword keyword-local">local</span> handle <span class="token operator">=</span> io<span class="token punctuation">.</span><span class="token function">popen</span><span class="token punctuation">(</span><span class="token string">"sort"</span><span class="token punctuation">,</span> <span class="token string">"w"</span><span class="token punctuation">)</span>
handle<span class="token punctuation">:</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">"banana\napple\ncherry"</span><span class="token punctuation">)</span>
handle<span class="token punctuation">:</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></li>
</ul>
</li>
</ul>
</li>
</ul>
<p><strong>实例1：临时改变流</strong></p>
<pre data-role="codeBlock" data-info="lua" class="language-lua lua"><code><span class="token keyword keyword-local">local</span> temp <span class="token operator">=</span> io<span class="token punctuation">.</span><span class="token function">input</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">-- 保存旧流</span>
io<span class="token punctuation">.</span><span class="token function">input</span><span class="token punctuation">(</span><span class="token string">"newinput"</span><span class="token punctuation">)</span> <span class="token comment">-- 打开新流</span>
<span class="token comment">-- 新流操作</span>
io<span class="token punctuation">.</span><span class="token function">input</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">-- 关闭新流</span>
io<span class="token punctuation">.</span><span class="token function">input</span><span class="token punctuation">(</span>temp<span class="token punctuation">)</span> <span class="token comment">-- 还原旧流</span>
</code></pre><p><strong>实例2：获取文件大小</strong></p>
<pre data-role="codeBlock" data-info="lua" class="language-lua lua"><code><span class="token keyword keyword-function">function</span> <span class="token function">fsize</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span>
    <span class="token keyword keyword-local">local</span> current <span class="token operator">=</span> file<span class="token punctuation">:</span><span class="token function">seek</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">-- 保存当前位置</span>
    <span class="token keyword keyword-local">local</span> size <span class="token operator">=</span> file<span class="token punctuation">:</span><span class="token function">seek</span><span class="token punctuation">(</span><span class="token string">"end"</span><span class="token punctuation">)</span> <span class="token comment">-- 获取文件大小</span>
    file<span class="token punctuation">:</span><span class="token function">seek</span><span class="token punctuation">(</span><span class="token string">"set"</span><span class="token punctuation">,</span> current<span class="token punctuation">)</span> <span class="token comment">-- 恢复当前位置</span>
    <span class="token keyword keyword-return">return</span> size
<span class="token keyword keyword-end">end</span>
</code></pre><h2 id="操作系统库os">操作系统库os </h2>
<p>os和io很相近，io为<strong>流</strong>，而os为<strong>真实文件</strong><br>
<strong>大概有：</strong></p>
<ul>
<li><strong>程序执行相关</strong>
<ul>
<li><code>rename()</code>：文件重命名(错误时返回nil+错误信息+错误码)</li>
<li><code>remove()</code>：文件删除(错误时同上)</li>
<li><code>exit()</code>：终止程序的执行
<ul>
<li>参数1<code>code</code>：退出码　默认为0，即成功</li>
<li>参数2<code>close</code>：是否关闭Lua状态并调用所有析构器释放所有内存　默认为true</li>
</ul>
</li>
<li><code>getenv()</code>：获取某个环境变量(就是Windows的那个环境变量)</li>
<li><code>execute()</code>：运行系统命令，等价于C的system函数<br>
如：<code>os.execute("mkdir" .. dirname) -- 创建目录</code></li>
</ul>
</li>
<li><strong>时间相关</strong>
<ul>
<li>
<p>表示方式：</p>
<ul>
<li>秒数，即自1970.1.1.00:00开始经过的秒数</li>
<li>日期表，即用表来表示日期，如：<code>{year = 1998, month = 9, day = 16, yday = 259, wday = 4, hour = 23, min = 48, sec = 10, isdst = false}</code></li>
</ul>
</li>
<li>
<p><code>time([table])</code>：返回当前的时间(使用秒数表示)</p>
<ul>
<li>可选参数<code>table</code>：是一个日期表，时间为该日期的秒数
<ul>
<li>year/month/day是必须的</li>
<li>hour/min/sec不是必须的，默认时间为12:00:00</li>
<li>wday/yday会被忽略</li>
</ul>
</li>
<li>可以进行一系列<strong>转换</strong>：</li>
</ul>
<pre data-role="codeBlock" data-info="lua" class="language-lua lua"><code><span class="token keyword keyword-local">local</span> date <span class="token operator">=</span> <span class="token number">1439653520</span>
<span class="token keyword keyword-local">local</span> day2year <span class="token operator">=</span> <span class="token number">365.242</span>       <span class="token comment">-- 1年的天数</span>
<span class="token keyword keyword-local">local</span> sec2hour <span class="token operator">=</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span>       <span class="token comment">-- 1小时的秒数</span>
<span class="token keyword keyword-local">local</span> sec2day <span class="token operator">=</span> sec2hour <span class="token operator">*</span> <span class="token number">24</span>  <span class="token comment">-- 1天的秒数</span>
<span class="token keyword keyword-local">local</span> sec2year <span class="token operator">=</span> sec2day <span class="token operator">*</span> day2year  <span class="token comment">-- 1年的秒数</span>

<span class="token comment">-- 年</span>
<span class="token function">print</span><span class="token punctuation">(</span>date <span class="token operator">//</span> sec2year <span class="token operator">+</span> <span class="token number">1970</span><span class="token punctuation">)</span>  <span class="token comment">--&gt; 2015.0</span>
<span class="token comment">-- 小时 (UTC格式)</span>
<span class="token function">print</span><span class="token punctuation">(</span>date <span class="token operator">%</span> sec2day <span class="token operator">//</span> sec2hour<span class="token punctuation">)</span>  <span class="token comment">--&gt; 15</span>
<span class="token comment">-- 分钟</span>
<span class="token function">print</span><span class="token punctuation">(</span>date <span class="token operator">%</span> sec2hour <span class="token operator">//</span> <span class="token number">60</span><span class="token punctuation">)</span>  <span class="token comment">--&gt; 45</span>
<span class="token comment">-- 秒</span>
<span class="token function">print</span><span class="token punctuation">(</span>date <span class="token operator">%</span> <span class="token number">60</span><span class="token punctuation">)</span>  <span class="token comment">--&gt; 20</span>
</code></pre></li>
<li>
<p><code>date(format[,time])</code>：可以认为是<code>time()</code>的反函数</p>
<ul>
<li>参数1<code>format</code>：格式字符串，类似<code>%Y-%m-%d %H:%M:%S</code>
<ul>
<li>特殊字符串<code>"*t"</code>用于返回日期表</li>
<li>开头添加<code>!</code>会以UTC进行解析</li>
<li>默认使用<code>%c</code>格式</li>
</ul>
</li>
<li>可选参数2<code>time</code>：需要格式化的秒数</li>
</ul>
</li>
<li>
<p><code>difftime(t2,t1)</code>：计算从开始时间t1到结束时间t2的秒数</p>
</li>
<li>
<p><code>clock()</code>：获取CPU时间　<strong><vt>高精度</vt></strong></p>
</li>
<li>
<p>计算相关：</p>
<ul>
<li>
<p>基本推算时间方式：</p>
<pre data-role="codeBlock" data-info="lua" class="language-lua lua"><code>t <span class="token operator">=</span> os<span class="token punctuation">.</span><span class="token function">date</span><span class="token punctuation">(</span><span class="token string">"*t"</span><span class="token punctuation">)</span> <span class="token comment">-- 当前时间</span>
t<span class="token punctuation">.</span>day <span class="token operator">=</span> t<span class="token punctuation">.</span>day <span class="token operator">+</span> <span class="token number">40</span> <span class="token comment">-- 向后40天</span>
<span class="token function">print</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span><span class="token function">date</span><span class="token punctuation">(</span><span class="token string">"%Y/%m/%d"</span><span class="token punctuation">,</span> os<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></li>
<li>
<p><strong>日历机制会导致错误：　　<vt>这是一个与Lua语言无关的问题</vt></strong><br>
3.31加上一个月(<code>t.month=t.month+1</code>)会得到4.31，归一化后得到5.1<br>
而5.1减去一个月会得到4.1而非3.31</p>
</li>
<li>
<p>高精度测试用法：</p>
<pre data-role="codeBlock" data-info="lua" class="language-lua lua"><code><span class="token keyword keyword-local">local</span> x <span class="token operator">=</span> os<span class="token punctuation">.</span><span class="token function">clock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword keyword-local">local</span> s <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword keyword-for">for</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">100000</span> <span class="token keyword keyword-do">do</span> s <span class="token operator">=</span> s<span class="token operator">+</span>i <span class="token keyword keyword-end">end</span>
<span class="token function">print</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"elapsed time: %.2f\n"</span><span class="token punctuation">,</span> os<span class="token punctuation">.</span><span class="token function">clock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> x<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="调试库debug">调试库debug </h2>
<p>调试库与反射机制有关，虽然Lua是动态语言支持几种反射机制，但还是有所缺失：</p>
<ul>
<li>程序不能检查局部变量</li>
<li>开发人员不能跟踪代码的执行</li>
</ul>
<p>所以需要调试库进行填补，调试库有两类：<br>
1.<strong>自省函数</strong>---允许检查运行中的程序的各个内容<br>
2.<strong>钩子hook</strong>---允许跟踪程序的执行</p>
<p>和一般的反射相同，<strong><drd>调试库必须谨慎使用</drd></strong>，因为会造成<vt><b>性能降低</b>与<b>打破固有规则</b><vt></vt></vt></p>
<p><strong>大概有：</strong></p>
<ul>
<li>
<p><strong>自省机制</strong></p>
<ul>
<li>
<p><code>getinfo([thread,]f[,what])</code>：用于获取函数或栈层次的调试信息</p>
<ul>
<li>
<p>参数<code>f</code>：级别，1代表当前函数，2代表函数父级</p>
</li>
<li>
<p>对于该函数来说，会返回一个数据表，<br>
可能有以下字段：<code>source</code> <code>short_src</code> <code>linedefined</code> <code>lastlinedefined</code> <code>what</code> <code>name</code> <code>namewhat</code> <code>nups</code> <code>nparams</code> <code>isvararg</code> <code>activelines</code> <code>func</code><br>
对于带有栈层次来说有额外字段：<code>currentline</code> <code>istailcall</code></p>
</li>
<li>
<p>对于C函数来说，信息只有<code>what</code> <code>name</code> <code>namewhat</code> <code>nups</code> <code>func</code></p>
</li>
<li>
<p>可选参数<code>what</code>：为例提高效率，可以选择需要的信息<vt>(这意味着<b>默认所有字段都会收集</b>)</vt></p>
<ul>
<li>选择有：
<ul>
<li><code>"n"</code>---<code>name</code> <code>namewhat</code></li>
<li><code>"f"</code>---<code>func</code></li>
<li><code>"S"</code>---<code>source</code> <code>short_src</code> <code>what</code> <code>linedefined</code> <code>lastlinedefined</code></li>
<li><code>"l"</code>---<code>currentline</code></li>
<li><code>"L"</code>---<code>activelines</code></li>
<li><code>"u"</code>---<code>nups</code> <code>nparams</code> <code>isvararg</code></li>
</ul>
</li>
</ul>
</li>
<li>
<p>用法如下：</p>
<pre data-role="codeBlock" data-info="lua" class="language-lua lua"><code><span class="token keyword keyword-function">function</span> <span class="token function">traceback</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-for">for</span> level <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> math<span class="token punctuation">.</span>huge <span class="token keyword keyword-do">do</span>
        <span class="token keyword keyword-local">local</span> info <span class="token operator">=</span> debug<span class="token punctuation">.</span><span class="token function">getinfo</span><span class="token punctuation">(</span>level<span class="token punctuation">,</span> <span class="token string">"Sl"</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> info <span class="token keyword keyword-then">then</span> <span class="token keyword keyword-break">break</span> <span class="token keyword keyword-end">end</span>
        <span class="token keyword keyword-if">if</span> info<span class="token punctuation">.</span>what <span class="token operator">==</span> <span class="token string">"C"</span> <span class="token keyword keyword-then">then</span>  <span class="token comment">-- 是否是C函数?</span>
            <span class="token function">print</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%d\tC function"</span><span class="token punctuation">,</span> level<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-else">else</span>  <span class="token comment">-- Lua函数</span>
            <span class="token function">print</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%d\t[%s]:%d"</span><span class="token punctuation">,</span> level<span class="token punctuation">,</span> 
                info<span class="token punctuation">.</span>short_src<span class="token punctuation">,</span> info<span class="token punctuation">.</span>currentline<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-end">end</span>
    <span class="token keyword keyword-end">end</span>
<span class="token keyword keyword-end">end</span>
</code></pre></li>
</ul>
</li>
<li>
<p><code>traceback([thread,][message[,level]])</code>：Lua提供的一种栈回溯方式(和上述实现类似)</p>
</li>
<li>
<p><code>getlocal([thread,]level,index)</code>：检查局部函数</p>
<ul>
<li>
<p>参数<code>level</code>---栈层次</p>
</li>
<li>
<p>参数<code>index</code>---变量的索引</p>
</li>
<li>
<p>返回变量名与变量当前值</p>
</li>
<li>
<p>使用例：</p>
<pre data-role="codeBlock" data-info="lua" class="language-lua lua"><code><span class="token keyword keyword-function">function</span> <span class="token function">foo</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span>
    <span class="token keyword keyword-local">local</span> x
    <span class="token keyword keyword-do">do</span> <span class="token keyword keyword-local">local</span> c <span class="token operator">=</span> a <span class="token operator">-</span> b <span class="token keyword keyword-end">end</span>
    <span class="token keyword keyword-local">local</span> a <span class="token operator">=</span> <span class="token number">1</span>
    <span class="token keyword keyword-while">while</span> <span class="token keyword keyword-true">true</span> <span class="token keyword keyword-do">do</span>
        <span class="token keyword keyword-local">local</span> name<span class="token punctuation">,</span> value <span class="token operator">=</span> debug<span class="token punctuation">.</span><span class="token function">getlocal</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span> <span class="token comment">-- 寻找每一个局部变量</span>
        <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> name <span class="token keyword keyword-then">then</span> <span class="token keyword keyword-break">break</span> <span class="token keyword keyword-end">end</span>
        <span class="token function">print</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
        a <span class="token operator">=</span> a <span class="token operator">+</span> <span class="token number">1</span>
    <span class="token keyword keyword-end">end</span>
<span class="token keyword keyword-end">end</span>

<span class="token function">foo</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token comment">--调用会返回：</span>
<span class="token comment">-- a 10</span>
<span class="token comment">-- b 20</span>
<span class="token comment">-- x nil</span>
<span class="token comment">-- a 4</span>
</code></pre></li>
<li>
<p>对于<strong>变长参数</strong>的获取，可以通过<strong>负索引</strong>来完成<br>
此时名字会是固定的<code>(*vararg)</code></p>
</li>
</ul>
</li>
<li>
<p><code>setlocal([thread,]level,index,value)</code>：更改局部变量的值</p>
</li>
<li>
<p><code>getupvalue([thread,]f,index)</code>：检查非局部函数(其实就是闭包中的upvalue)</p>
<ul>
<li>
<p>参数<code>f</code>---闭包函数</p>
</li>
<li>
<p>参数<code>index</code>---变量索引，和local的类似</p>
<pre data-role="codeBlock" data-info="lua" class="language-lua lua"><code><span class="token keyword keyword-function">function</span> <span class="token function">getvarvalue</span> <span class="token punctuation">(</span>name<span class="token punctuation">,</span> level<span class="token punctuation">,</span> isenv<span class="token punctuation">)</span>
    <span class="token keyword keyword-local">local</span> value
    <span class="token keyword keyword-local">local</span> found <span class="token operator">=</span> <span class="token keyword keyword-false">false</span>
    
    level <span class="token operator">=</span> <span class="token punctuation">(</span>level <span class="token keyword keyword-or">or</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span>
    
    <span class="token comment">-- 尝试局部变量</span>
    <span class="token keyword keyword-for">for</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> math<span class="token punctuation">.</span>huge <span class="token keyword keyword-do">do</span>
        <span class="token keyword keyword-local">local</span> n<span class="token punctuation">,</span> v <span class="token operator">=</span> debug<span class="token punctuation">.</span><span class="token function">getlocal</span><span class="token punctuation">(</span>level<span class="token punctuation">,</span> i<span class="token punctuation">)</span>
        <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> n <span class="token keyword keyword-then">then</span> <span class="token keyword keyword-break">break</span> <span class="token keyword keyword-end">end</span>
        <span class="token keyword keyword-if">if</span> n <span class="token operator">==</span> name <span class="token keyword keyword-then">then</span>
            value <span class="token operator">=</span> v
            found <span class="token operator">=</span> <span class="token keyword keyword-true">true</span>
        <span class="token keyword keyword-end">end</span>
    <span class="token keyword keyword-end">end</span>
    <span class="token keyword keyword-if">if</span> found <span class="token keyword keyword-then">then</span> <span class="token keyword keyword-return">return</span> <span class="token string">"local"</span><span class="token punctuation">,</span> value <span class="token keyword keyword-end">end</span>
    
    <span class="token comment">-- 尝试非局部变量</span>
    <span class="token keyword keyword-local">local</span> func <span class="token operator">=</span> debug<span class="token punctuation">.</span><span class="token function">getinfo</span><span class="token punctuation">(</span>level<span class="token punctuation">,</span> <span class="token string">"f"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>func
    <span class="token keyword keyword-for">for</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> math<span class="token punctuation">.</span>huge <span class="token keyword keyword-do">do</span>
        <span class="token keyword keyword-local">local</span> n<span class="token punctuation">,</span> v <span class="token operator">=</span> debug<span class="token punctuation">.</span><span class="token function">getupvalue</span><span class="token punctuation">(</span>func<span class="token punctuation">,</span> i<span class="token punctuation">)</span>
        <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> n <span class="token keyword keyword-then">then</span> <span class="token keyword keyword-break">break</span> <span class="token keyword keyword-end">end</span>
        <span class="token keyword keyword-if">if</span> n <span class="token operator">==</span> name <span class="token keyword keyword-then">then</span> <span class="token keyword keyword-return">return</span> <span class="token string">"upvalue"</span><span class="token punctuation">,</span> v <span class="token keyword keyword-end">end</span>
    <span class="token keyword keyword-end">end</span>
    
    <span class="token keyword keyword-if">if</span> isenv <span class="token keyword keyword-then">then</span> <span class="token keyword keyword-return">return</span> <span class="token string">"noenv"</span> <span class="token keyword keyword-end">end</span>  <span class="token comment">-- 避免循环</span>
    
    <span class="token comment">-- 没找到；从环境中获取值</span>
    <span class="token keyword keyword-local">local</span> _<span class="token punctuation">,</span> env <span class="token operator">=</span> <span class="token function">getvarvalue</span><span class="token punctuation">(</span><span class="token string">"_ENV"</span><span class="token punctuation">,</span> level<span class="token punctuation">,</span> <span class="token keyword keyword-true">true</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-if">if</span> env <span class="token keyword keyword-then">then</span>
        <span class="token keyword keyword-return">return</span> <span class="token string">"global"</span><span class="token punctuation">,</span> env<span class="token punctuation">[</span>name<span class="token punctuation">]</span>
    <span class="token keyword keyword-else">else</span>
        <span class="token keyword keyword-return">return</span> <span class="token string">"noenv"</span>  <span class="token comment">-- 没有有效的_ENV</span>
    <span class="token keyword keyword-end">end</span>
<span class="token keyword keyword-end">end</span>
</code></pre></li>
</ul>
</li>
<li>
<p>以上自省函数都可以接收一个thread即携程参数，用于检查携程</p>
<pre data-role="codeBlock" data-info="lua" class="language-lua lua"><code>co <span class="token operator">=</span> coroutine<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword keyword-function">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword keyword-local">local</span> x <span class="token operator">=</span> <span class="token number">10</span>
  coroutine<span class="token punctuation">.</span><span class="token function">yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"some error"</span><span class="token punctuation">)</span>
<span class="token keyword keyword-end">end</span><span class="token punctuation">)</span>

coroutine<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span>co<span class="token punctuation">)</span>
<span class="token function">print</span><span class="token punctuation">(</span>debug<span class="token punctuation">.</span><span class="token function">traceback</span><span class="token punctuation">(</span>co<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">-- 此时进入yield()</span>
<span class="token function">print</span><span class="token punctuation">(</span>coroutine<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span>co<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">-- false  temp:4: some error</span>
<span class="token function">print</span><span class="token punctuation">(</span>debug<span class="token punctuation">.</span><span class="token function">traceback</span><span class="token punctuation">(</span>co<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">-- 此时已经报错了，进入error()</span>
<span class="token function">print</span><span class="token punctuation">(</span>debug<span class="token punctuation">.</span><span class="token function">getlocal</span><span class="token punctuation">(</span>co<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">-- x 10，虽然已经报错了但还是可以检查</span>
</code></pre></li>
</ul>
</li>
<li>
<p><strong>钩子</strong></p>
<ul>
<li>
<p>钩子函数会在运行的特定事件调用，有：</p>
<ul>
<li>调用函数时的<code>call</code>事件</li>
<li>函数返回时的<code>return</code>事件</li>
<li>开始执行一行新代码时的<code>line</code>事件</li>
<li>执行完指定数量命令(内部操作码，即虚拟机指令)的<code>count</code>事件</li>
</ul>
</li>
<li>
<p><code>sethook([thread,] hook, mask [, count])</code>：注册钩子</p>
<ul>
<li>
<p>参数描述：</p>
<ul>
<li>参数1<code>hook</code>---钩子函数</li>
<li>参数2<code>mask</code>---描述要监控事件的掩码字符串</li>
<li>可选参数3<code>count</code>---描述获取count事件频率的数字</li>
</ul>
</li>
<li>
<p>不带参数的<code>sethook()</code>可关闭钩子</p>
</li>
<li>
<p>对于<code>call</code>/<code>return</code>/<code>line</code>事件，用法为：<br>
<code>debug.sethook(print, "l")</code>l即为line首字母(其余也是如此)</p>
</li>
<li>
<p>对于<code>count</code>事件，需要传入count，用法为：<br>
<code>debug.sethook(fun, "", 100)</code><vt>可以发现call和count都是<code>"c"</code>，这里只有传入count参数才会启用</vt></p>
</li>
<li>
<p>用法：</p>
<pre data-role="codeBlock" data-info="lua" class="language-lua lua"><code><span class="token comment">-- 例1：</span>
debug<span class="token punctuation">.</span><span class="token function">sethook</span><span class="token punctuation">(</span>print<span class="token punctuation">,</span> <span class="token string">"l"</span><span class="token punctuation">)</span>

<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"OK"</span><span class="token punctuation">)</span> <span class="token comment">-- 多输出：line 3   因为在第3行(而且line事件会返回类型line+行号)</span>

<span class="token comment">-- 例2：</span>
<span class="token comment">-- 加载跟踪功能</span>
<span class="token keyword keyword-function">function</span> <span class="token function">trace</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> line<span class="token punctuation">)</span>
  <span class="token keyword keyword-local">local</span> s <span class="token operator">=</span> debug<span class="token punctuation">.</span><span class="token function">getinfo</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>short_src
  <span class="token function">print</span><span class="token punctuation">(</span>s <span class="token operator">..</span> <span class="token string">":"</span> <span class="token operator">..</span> line<span class="token punctuation">)</span>
<span class="token keyword keyword-end">end</span>
debug<span class="token punctuation">.</span><span class="token function">sethook</span><span class="token punctuation">(</span>trace<span class="token punctuation">,</span> <span class="token string">"l"</span><span class="token punctuation">)</span>

<span class="token comment">-- 测试代码</span>
<span class="token keyword keyword-local">local</span> <span class="token keyword keyword-function">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword keyword-for">for</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span> <span class="token keyword keyword-do">do</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"测试"</span> <span class="token operator">..</span> i<span class="token punctuation">)</span>
  <span class="token keyword keyword-end">end</span>
<span class="token keyword keyword-end">end</span>
<span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">-- 完成后关闭跟踪</span>
debug<span class="token punctuation">.</span><span class="token function">sethook</span><span class="token punctuation">(</span><span class="token keyword keyword-nil">nil</span><span class="token punctuation">)</span>
</code></pre></li>
</ul>
</li>
<li>
<p><code>debug()</code>：即<code>debug.debug()</code>，提供了一个能够任意执行Lua语言命令的提示符，其实就是**<vt>发生错误了，在此处打上断点，通过命令行可进行调试</vt>**</p>
<ul>
<li>
<p>可能有：</p>
<pre data-role="codeBlock" data-info="lua" class="language-lua lua"><code><span class="token keyword keyword-function">function</span> <span class="token function">foo</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> n <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token keyword keyword-then">then</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"Error：Negative Number"</span><span class="token punctuation">)</span>
    debug<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">-- 在遇到问题时启动调试控制台</span>
    <span class="token keyword keyword-return">return</span> <span class="token operator">-</span><span class="token number">1</span>
  <span class="token keyword keyword-end">end</span>
  <span class="token keyword keyword-return">return</span> <span class="token number">1</span>
<span class="token keyword keyword-end">end</span>

<span class="token function">foo</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
</code></pre><p>此时执行foo(-1)后命令行会因<code>debug.debug()</code>的原因弹出<code>lua_debug&gt;</code>的命令行，此时我们可以输入命令进行观察<br>
我们其实可以自我实现该函数：</p>
<pre data-role="codeBlock" data-info="lua" class="language-lua lua"><code><span class="token keyword keyword-function">function</span> <span class="token function">debug</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword keyword-while">while</span> <span class="token keyword keyword-true">true</span> <span class="token keyword keyword-do">do</span>
    io<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">"debug&gt; "</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-local">local</span> line <span class="token operator">=</span> io<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-if">if</span> line <span class="token operator">==</span> <span class="token string">"cont"</span> <span class="token keyword keyword-then">then</span> <span class="token keyword keyword-break">break</span> <span class="token keyword keyword-end">end</span>
    <span class="token function">assert</span><span class="token punctuation">(</span><span class="token function">load</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword keyword-end">end</span>
<span class="token keyword keyword-end">end</span>
</code></pre></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>该类除了进行调试，还可以进行<b><gn>调优<gn><vt>(资源行为分析<gn>profile</gn>)</vt></gn></gn></b>：<br>
<strong><vt>Tip：时间相关调优最好使用C接口(钩子开销太大)，如果是计数性质的话Lua代码即可</vt></strong></p>
<pre data-role="codeBlock" data-info="lua" class="language-lua lua"><code><span class="token keyword keyword-local">local</span> Counters <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword keyword-local">local</span> Names <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword keyword-local">local</span> <span class="token keyword keyword-function">function</span> <span class="token function">hook</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-local">local</span> f <span class="token operator">=</span> debug<span class="token punctuation">.</span><span class="token function">getinfo</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"f"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>func
    <span class="token keyword keyword-local">local</span> count <span class="token operator">=</span> Counters<span class="token punctuation">[</span>f<span class="token punctuation">]</span>
    <span class="token keyword keyword-if">if</span> count <span class="token operator">==</span> <span class="token keyword keyword-nil">nil</span> <span class="token keyword keyword-then">then</span>    <span class="token comment">-- 'f'第一次被调用?</span>
        Counters<span class="token punctuation">[</span>f<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span>
        Names<span class="token punctuation">[</span>f<span class="token punctuation">]</span> <span class="token operator">=</span> debug<span class="token punctuation">.</span><span class="token function">getinfo</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"Sn"</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-else">else</span>    <span class="token comment">-- 只需递增计数器即可</span>
        Counters<span class="token punctuation">[</span>f<span class="token punctuation">]</span> <span class="token operator">=</span> count <span class="token operator">+</span> <span class="token number">1</span>
    <span class="token keyword keyword-end">end</span>
<span class="token keyword keyword-end">end</span>

<span class="token keyword keyword-local">local</span> f <span class="token operator">=</span> <span class="token function">assert</span><span class="token punctuation">(</span><span class="token function">loadfile</span><span class="token punctuation">(</span>arg<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">-- 加载主程序</span>
debug<span class="token punctuation">.</span><span class="token function">sethook</span><span class="token punctuation">(</span>hook<span class="token punctuation">,</span> <span class="token string">"c"</span><span class="token punctuation">)</span>
<span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">-- 执行主程序</span>
debug<span class="token punctuation">.</span><span class="token function">sethook</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword keyword-function">function</span> <span class="token function">getname</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span>
    <span class="token keyword keyword-local">local</span> n <span class="token operator">=</span> Names<span class="token punctuation">[</span>func<span class="token punctuation">]</span>
    <span class="token keyword keyword-if">if</span> n<span class="token punctuation">.</span>what <span class="token operator">==</span> <span class="token string">"C"</span> <span class="token keyword keyword-then">then</span>
        <span class="token keyword keyword-return">return</span> n<span class="token punctuation">.</span>name
    <span class="token keyword keyword-end">end</span>
    <span class="token keyword keyword-local">local</span> lc <span class="token operator">=</span> string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"[%s]:%d"</span><span class="token punctuation">,</span> n<span class="token punctuation">.</span>short_src<span class="token punctuation">,</span> n<span class="token punctuation">.</span>linedefined<span class="token punctuation">)</span>
    <span class="token keyword keyword-if">if</span> n<span class="token punctuation">.</span>what <span class="token operator">~=</span> <span class="token string">"main"</span> <span class="token keyword keyword-and">and</span> n<span class="token punctuation">.</span>namewhat <span class="token operator">~=</span> <span class="token string">""</span> <span class="token keyword keyword-then">then</span>
        <span class="token keyword keyword-return">return</span> string<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%s (%s)"</span><span class="token punctuation">,</span> lc<span class="token punctuation">,</span> n<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
    <span class="token keyword keyword-else">else</span>
        <span class="token keyword keyword-return">return</span> lc
    <span class="token keyword keyword-end">end</span>
<span class="token keyword keyword-end">end</span>

<span class="token keyword keyword-for">for</span> func<span class="token punctuation">,</span> count <span class="token keyword keyword-in">in</span> <span class="token function">pairs</span><span class="token punctuation">(</span>Counters<span class="token punctuation">)</span> <span class="token keyword keyword-do">do</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token function">getname</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span>
<span class="token keyword keyword-end">end</span>
</code></pre><p>除此以外，甚至还能利用count事件钩子限制代码执行命令数来避免Dos攻击<br>
这被称为<b><gn>沙盒</gn></b>：</p>
<pre data-role="codeBlock" data-info="lua" class="language-lua lua"><code><span class="token keyword keyword-local">local</span> debug <span class="token operator">=</span> require <span class="token string">"debug"</span>

<span class="token comment">-- 最大能够使用的内存（单位KB）</span>
<span class="token keyword keyword-local">local</span> memlimit <span class="token operator">=</span> <span class="token number">1000</span>
<span class="token comment">-- 最大能够执行的"steps"</span>
<span class="token keyword keyword-local">local</span> steplimit <span class="token operator">=</span> <span class="token number">1000</span>

<span class="token comment">-- 设置授权的函数</span>
<span class="token keyword keyword-local">local</span> validfunc <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token punctuation">[</span>string<span class="token punctuation">.</span>upper<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword keyword-true">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span>string<span class="token punctuation">.</span>lower<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword keyword-true">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">...</span>            <span class="token comment">-- 其他授权的函数</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-local">local</span> <span class="token keyword keyword-function">function</span> <span class="token function">checkmem</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword keyword-if">if</span> <span class="token function">collectgarbage</span><span class="token punctuation">(</span><span class="token string">"count"</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> memlimit <span class="token keyword keyword-then">then</span>
    <span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"script uses too much memory"</span><span class="token punctuation">)</span>
  <span class="token keyword keyword-end">end</span>
<span class="token keyword keyword-end">end</span>

<span class="token keyword keyword-local">local</span> count <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword keyword-local">local</span> <span class="token keyword keyword-function">function</span> <span class="token function">hook</span> <span class="token punctuation">(</span>event<span class="token punctuation">)</span>
  <span class="token comment">-- 限制调用函数</span>
  <span class="token keyword keyword-if">if</span> event <span class="token operator">==</span> <span class="token string">"call"</span> <span class="token keyword keyword-then">then</span>
    <span class="token keyword keyword-local">local</span> info <span class="token operator">=</span> debug<span class="token punctuation">.</span><span class="token function">getinfo</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"fn"</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> validfunc<span class="token punctuation">[</span>info<span class="token punctuation">.</span>func<span class="token punctuation">]</span> <span class="token keyword keyword-then">then</span>
      <span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"calling bad function: "</span> <span class="token operator">..</span> <span class="token punctuation">(</span>info<span class="token punctuation">.</span>name <span class="token keyword keyword-or">or</span> <span class="token string">"?"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-end">end</span>
  <span class="token keyword keyword-end">end</span>

  <span class="token function">checkmem</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">-- 限制内存占用</span>
  count <span class="token operator">=</span> count <span class="token operator">+</span> <span class="token number">1</span>
  <span class="token keyword keyword-if">if</span> count <span class="token operator">&gt;</span> steplimit <span class="token keyword keyword-then">then</span> <span class="token comment">-- 限制调用次数</span>
    <span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"script uses too much CPU"</span><span class="token punctuation">)</span>
  <span class="token keyword keyword-end">end</span>
<span class="token keyword keyword-end">end</span>

<span class="token comment">-- 加载</span>
<span class="token keyword keyword-local">local</span> f <span class="token operator">=</span> <span class="token function">assert</span><span class="token punctuation">(</span><span class="token function">loadfile</span><span class="token punctuation">(</span>arg<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"t"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

debug<span class="token punctuation">.</span><span class="token function">sethook</span><span class="token punctuation">(</span>step<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>    <span class="token comment">-- 设置钩子</span>

<span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment">-- 运行文件</span>
</code></pre><p>在沙盒中，限制函数很关键，我们<b><vt>应该考虑添加哪些函数而非删除</vt></b>，<br>
对于各类函数来说：</p>
<ul>
<li>数学库math都是安全的</li>
<li>字符串库string大部分都是安全的(需要小心资源消耗)</li>
<li>模块库package与调试库debug几乎都是危险的</li>
<li><code>setmetatable()</code>和<code>getmetatable()</code>很危险，<code>__index</code>可以访问不存在的值，<code>__gc</code>可以在沙盒外回收</li>
</ul>

      </div>
      
      
    
    
    
    
    
    
  
    </body></html>